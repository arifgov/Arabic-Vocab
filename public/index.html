<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6366f1">
    <title>Madinah Arabic Vocab Trainer</title>
    <!-- Cache busting: Update version query param when releasing new version -->
    <link rel="stylesheet" href="styles.css?v=1.0.1">
    <link rel="manifest" href="manifest.json?v=1.0.1">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase Configuration
        // WARNING: These credentials are public in client-side code but should be protected
        // by Firebase Security Rules. In production, consider loading from environment variables.
        // For client-side Firebase apps, these values are exposed but Firebase Security Rules
        // provide the actual protection for your data.
        const firebaseConfig = {
            apiKey: "AIzaSyC50gRTrmyS-Q6geZdMHCMCs3mI2_TwcN0",
            authDomain: "arabic-vocab-trainer.firebaseapp.com",
            projectId: "arabic-vocab-trainer",
            storageBucket: "arabic-vocab-trainer.firebasestorage.app",
            messagingSenderId: "578452653672",
            appId: "1:578452653672:web:89e5613b79608294bedddd"
        };
        
        // Store config globally for access by other modules
        window.firebaseConfig = firebaseConfig;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Set persistence to LOCAL - survives browser restarts (like Gmail)
        setPersistence(auth, browserLocalPersistence)
            .then(() => {
                console.log('‚úÖ Firebase Auth persistence set to LOCAL');
            })
            .catch((error) => {
                console.error('‚ùå Error setting persistence:', error);
            });
        
        // Make available globally
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
    </script>
</head>
<body>
    <!-- Global Navigation Header -->
    <nav class="global-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="nav-icon">üïå</span>
                <span class="nav-title">Madinah Arabic Vocab Trainer</span>
            </div>
            <div class="nav-actions">
                <button id="nav-home-btn" class="nav-btn">
                    <span>üè†</span>
                    <span>Home</span>
                </button>
                <div id="user-menu" class="user-menu" style="display: none;">
                    <button id="user-btn" class="nav-btn user-btn">
                        <span id="user-avatar">üë§</span>
                        <span id="user-name">User</span>
                    </button>
                    <div id="user-dropdown" class="user-dropdown" style="display: none;">
                        <div class="user-info">
                            <div id="dropdown-user-name"></div>
                            <div id="dropdown-user-email"></div>
                            <div id="dropdown-version" style="font-size: 0.75em; color: #888; margin-top: 4px;">Version 1.0.1</div>
                        </div>
                        <div class="dropdown-divider"></div>
                        
                        <button id="sync-to-firebase-btn" class="dropdown-item" style="display: none;">Sync to Cloud Now</button>
                        <button id="clear-cache-btn" class="dropdown-item" style="display: none;">Clear Local Store and Sync from Cloud</button>
                        <div class="dropdown-divider" id="admin-divider" style="display: none;"></div>
                        <button id="reset-lesson-menu-btn" class="dropdown-item" style="display: none;">Reset This Lesson</button>
                        <button id="reset-all-menu-btn" class="dropdown-item" style="display: none;">Reset All Progress</button>
                        <button id="admin-portal-btn" class="dropdown-item" style="display: none;">üõ°Ô∏è Admin Portal</button>
                        <div class="dropdown-divider"></div>
                        <button id="logout-btn" class="dropdown-item">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login View -->
    <div id="login-view" class="view" style="display: none;">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <span class="login-icon">üïå</span>
                    <h1>Madinah Arabic Vocab Trainer</h1>
                    <p>Sign in to sync your progress across devices</p>
                </div>
                
                <div class="login-options">
                    <button id="google-login-btn" class="login-btn google-btn">
                        <span class="login-icon">üîµ</span>
                        <span>Continue with Google</span>
                    </button>
                </div>
                
                <div class="login-footer">
                    <p class="login-note">You can use the app offline, but signing in lets you sync progress across devices.</p>
                    <button id="skip-login-btn" class="skip-btn">Continue without signing in</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view active">
            <header class="page-header">
                <h1>Vocabulary Dashboard</h1>
                <p class="page-subtitle">Select a book and lesson to begin practicing</p>
            </header>
            
            <div class="book-selector">
                <button class="book-btn active" data-book="1"><span>üìñ Book 1</span></button>
                <button class="book-btn" data-book="2"><span>üìö Book 2</span></button>
            </div>
            
            <div class="global-stats">
                <div class="stat-item">
                    <span class="stat-label">üìù Tests</span>
                    <span id="total-words" class="stat-value">0/0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üìö Total Words</span>
                    <span id="total-mastered" class="stat-value">0</span>
                </div>
            </div>
            
            <div id="lessons-list" class="lessons-list"></div>
            
        </div>
        
        <!-- Lesson View -->
        <div id="lesson-view" class="view">
            <header class="page-header">
                <div class="breadcrumb">
                    <button id="back-to-dashboard" class="breadcrumb-link">‚Üê Dashboard</button>
                    <span class="breadcrumb-separator">/</span>
                    <span id="lesson-title" class="breadcrumb-current"></span>
                </div>
            </header>
            
            <div class="mode-progress-container">
                <!-- English-Arabic Progress -->
                <div class="mode-progress-card">
                    <div class="mode-progress-header">
                        <h3>English ‚Üí Arabic</h3>
                        <button id="go-english-arabic-btn" class="btn btn-primary btn-go">Go</button>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-english-arabic" class="progress-fill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="text-english-arabic">0 / 0 words</span>
                    </div>
                </div>
                
                <!-- Arabic-English Progress -->
                <div class="mode-progress-card">
                    <div class="mode-progress-header">
                        <h3>Arabic ‚Üí English</h3>
                        <button id="go-arabic-english-btn" class="btn btn-primary btn-go">Go</button>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-arabic-english" class="progress-fill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="text-arabic-english">0 / 0 words</span>
                    </div>
                    <div class="review-mistakes-btn-container" style="margin-top: 0.5rem;">
                        <button id="review-mistakes-arabic-english-btn" class="btn btn-secondary btn-sm" style="display: none;">Review Mistakes</button>
                    </div>
                </div>
                
                <!-- Mixed Progress -->
                <div class="mode-progress-card">
                    <div class="mode-progress-header">
                        <h3>Mixed</h3>
                        <button id="go-mixed-btn" class="btn btn-primary btn-go">Go</button>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-mixed" class="progress-fill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="text-mixed">0 / 0 words</span>
                    </div>
                    <div class="review-mistakes-btn-container" style="margin-top: 0.5rem;">
                        <button id="review-mistakes-mixed-btn" class="btn btn-secondary btn-sm" style="display: none;">Review Mistakes</button>
                    </div>
                </div>
            </div>
            
            <div class="lesson-actions">
                <button id="final-test-btn" class="btn btn-success" style="display: none;">Take Final Test (75% Mixed)</button>
            </div>
        </div>
        
        <!-- Question View -->
        <div id="question-view" class="view">
            <header class="page-header">
                <div class="breadcrumb">
                    <button id="back-to-lesson" class="breadcrumb-link">‚Üê Lesson</button>
                    <span class="breadcrumb-separator">/</span>
                    <span id="question-number" class="breadcrumb-current">Question 1</span>
                </div>
                <div id="final-test-banner" class="final-test-banner" style="display: none;">
                    <span class="banner-icon">üéØ</span>
                    <span class="banner-text">Final Test - 75% Mixed Mode - Need 100% to Pass</span>
                </div>
                <div class="question-stats-bar">
                    <div class="stat-badge correct-badge">
                        <span class="stat-icon">‚úÖ</span>
                        <span id="question-correct-count">0</span>
                    </div>
                    <div class="stat-badge incorrect-badge">
                        <span class="stat-icon">‚ùå</span>
                        <span id="question-incorrect-count">0</span>
                    </div>
                </div>
            </header>
            
            <div class="question-container">
                <div id="question-prompt" class="prompt"></div>
                
                <div id="mcq-options" class="mcq-options" style="display: none;">
                    <!-- Radio buttons will be inserted here -->
                </div>
                
                <div id="typing-input-container" class="typing-input-container" style="display: none;">
                    <input type="text" id="answer-input" placeholder="Type the English meaning" autocomplete="off">
                </div>
                
                <div class="question-actions">
                    <button id="check-btn" class="btn btn-primary">Check</button>
                    <button id="next-btn" class="btn btn-secondary" style="display: none;">Next</button>
                </div>
                
                <div id="feedback" class="feedback"></div>
            </div>
        </div>
        
        <!-- Summary View -->
        <div id="summary-view" class="view">
            <header class="page-header">
                <div class="breadcrumb">
                    <button id="back-to-lesson-summary" class="breadcrumb-link">‚Üê Lesson</button>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current">Session Summary</span>
                </div>
            </header>
            
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="summary-attempted">0</div>
                    <div class="stat-label">üìù Attempted</div>
                </div>
                <div class="stat-card correct">
                    <div class="stat-number" id="summary-correct">0</div>
                    <div class="stat-label">‚úÖ Correct</div>
                </div>
                <div class="stat-card incorrect">
                    <div class="stat-number" id="summary-incorrect">0</div>
                    <div class="stat-label">‚ùå Incorrect</div>
                </div>
            </div>
            
                <div id="weak-words-list" class="weak-words-list">
                    <h3>üìå Words to Review</h3>
                </div>
            
            <div class="summary-actions">
                <button id="review-again-btn" class="btn btn-secondary">Review Mistakes Only</button>
                <button id="back-to-lesson-btn" class="btn btn-primary">Back to Lesson</button>
                <button id="next-lesson-btn" class="btn btn-success" style="display: none;">Next Lesson</button>
            </div>
        </div>
    </div>
    
    <!-- Admin View -->
    <div id="admin-view" class="view">
        <header class="page-header">
            <div class="breadcrumb">
                <button id="admin-back-to-dashboard" class="breadcrumb-link">‚Üê Dashboard</button>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">Admin Portal</span>
            </div>
            <h1>üõ°Ô∏è Admin Portal</h1>
            <p class="page-subtitle">Manage user progress and test completion</p>
        </header>
        
        <div id="admin-content">
            <div id="admin-loading" class="admin-loading">
                <p>Loading users...</p>
            </div>
            <div id="admin-error" class="admin-error" style="display: none;"></div>
            <div id="admin-users-list" class="admin-users-list" style="display: none;"></div>
            <div id="admin-user-detail" class="admin-user-detail" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Cache busting: Update version query param when releasing new version -->
    <script src="firebase-auth.js?v=1.0.1"></script>
    <script src="firebase-sync.js?v=1.0.1"></script>
    <script src="main.js?v=1.0.1"></script>
    <script src="admin.js?v=1.0.1"></script>
    <script>
        // Register service worker with cache busting
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Add version query param to force update
                navigator.serviceWorker.register('/sw.js?v=1.0.1')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                        
                        // Listen for service worker updates (but don't auto-reload to avoid loops)
                        registration.addEventListener('updatefound', () => {
                            console.log('New service worker version found');
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('New service worker activated');
                                    // Don't auto-reload - let user decide or reload on next visit
                                    // Auto-reload can cause infinite loops
                                }
                            });
                        });
                        
                        // Check for updates less frequently to avoid issues
                        setInterval(() => {
                            registration.update().catch(err => {
                                // Silently ignore update errors
                                console.warn('Service worker update check failed:', err);
                            });
                        }, 300000); // Check every 5 minutes instead of every minute
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                        // Don't block app if service worker fails
                    });
                
                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'SW_UPDATE') {
                        console.log('Service Worker update detected, version:', event.data.version);
                        // Don't auto-reload - just log it
                        // User can manually reload if needed
                    }
                });
            });
        }
    </script>
</body>
</html>

